# Production Configuration for Strategiz
#
# Active profiles (set via SPRING_PROFILES_ACTIVE environment variable in Dockerfile):
# - prod: Production settings (Vault, Firebase, etc.)
# - scheduler: Batch job beans for dynamic scheduling (MarketDataIncrementalJob, etc.)
#
# Note: Do NOT set spring.profiles.active or spring.profiles.include here.
# Spring Boot 3 does not allow profile activation from profile-specific files.

# Server Configuration
server.port=${PORT:8080}
# Disable SSL - Cloud Run handles TLS termination at the load balancer
server.ssl.enabled=false
# Disable custom HTTPS connector (not needed in Cloud Run)
https.enabled=false

# Security
server.servlet.session.cookie.secure=true
server.servlet.session.cookie.same-site=None

# Console Admin Authentication (require ADMIN role in production)
console.auth.enabled=true

# Custom Cookie Configuration for cross-origin AJAX with credentials
# Domain set to strategiz.io (browsers automatically apply to all subdomains)
# (api.strategiz.io, console.strategiz.io, auth.strategiz.io)
app.cookie.secure=true
app.cookie.same-site=None
app.cookie.domain=strategiz.io

# Session Management
# Idle timeout: reject token refresh if user inactive for this long (strict security)
session.idle.timeout.seconds=1800

# Firebase Configuration (from environment variables)
firebase.database-url=${FIREBASE_DATABASE_URL:https://strategiz-io.firebaseio.com}
firebase.project-id=${FIREBASE_PROJECT_ID:strategiz-io}
firebase.service-account-key=${FIREBASE_SERVICE_ACCOUNT_KEY}
firebase.storage.bucket=${FIREBASE_STORAGE_BUCKET:strategiz-io.firebasestorage.app}

# Enable Vault in production for centralized secret management
strategiz.vault.enabled=true
strategiz.vault.address=${STRATEGIZ_VAULT_ADDRESS:${VAULT_ADDR:https://strategiz-vault-43628135674.us-east1.run.app}}
strategiz.vault.cache-timeout-ms=60000
strategiz.vault.fail-fast=true
strategiz.vault.secrets-path=secret

# Spring Cloud Vault configuration for production
spring.cloud.vault.uri=${VAULT_ADDR:https://strategiz-vault-43628135674.us-east1.run.app}
spring.cloud.vault.token=${VAULT_TOKEN:}
spring.cloud.vault.kv.enabled=true
spring.cloud.vault.kv.backend=secret
spring.cloud.vault.kv.default-context=strategiz

# CORS Configuration
strategiz.cors.allowed-origins=https://strategiz-io.web.app,https://strategiz-io.firebaseapp.com,https://strategiz.io,https://console.strategiz.io,https://strategiz-console.web.app,https://auth.strategiz.io,https://strategiz-auth.web.app

# Logging
logging.level.root=INFO
logging.level.io.strategiz=INFO
logging.level.org.springframework.web=INFO
logging.level.org.springframework.security=INFO
# SQL Debug Logging - shows actual SQL queries and parameters
logging.level.org.springframework.jdbc.core.JdbcTemplate=DEBUG
logging.level.org.springframework.jdbc.core.StatementCreatorUtils=TRACE
# Robinhood client logging (temporary - to diagnose MFA/push auth flow)
logging.level.io.strategiz.client.robinhood=DEBUG
# ClickHouse repository logging
logging.level.io.strategiz.data.marketdata.clickhouse=DEBUG

# Actuator endpoints for health checks and observability
management.endpoints.web.exposure.include=health,info,prometheus,metrics
management.endpoint.health.show-details=when-authorized
# Disable Vault health indicator - secrets are loaded at startup, ongoing health check not needed
management.health.vault.enabled=false
management.endpoint.prometheus.enabled=true
management.metrics.export.prometheus.enabled=true
management.metrics.tags.application=strategiz-core

# ====================================================
# Grafana Cloud OpenTelemetry Configuration
# ====================================================
# OTLP Exporter - Grafana Cloud endpoints
# Get your instance details from: https://grafana.com/docs/grafana-cloud/monitor-infrastructure/otlp/
otel.exporter.otlp.endpoint=${GRAFANA_OTLP_ENDPOINT:https://otlp-gateway-prod-us-east-3.grafana.net/otlp}
otel.exporter.otlp.protocol=http/protobuf

# Authentication - Grafana Cloud uses Basic Auth
# Username = Instance ID, Password = API Token (stored in Vault)
otel.exporter.otlp.headers=Authorization=Basic ${GRAFANA_OTLP_AUTH_HEADER:}

# Service identification
otel.service.name=strategiz-core
otel.resource.attributes=service.namespace=strategiz,deployment.environment=production,service.version=1.0.0

# Tracing configuration - 10% sampling for production to reduce costs
otel.traces.exporter=otlp
otel.traces.sampler=parentbased_traceidratio
otel.traces.sampler.arg=${OTEL_SAMPLING_RATIO:0.1}

# Metrics configuration
otel.metrics.exporter=otlp

# Logging configuration
otel.logs.exporter=otlp

# Propagation context for distributed tracing
otel.propagators=tracecontext,baggage

# Grafana Prometheus Query API - for fetching metrics in console
# This is used by GrafanaMetricsClient to query stored metrics
grafana.prometheus.url=${GRAFANA_PROMETHEUS_URL:https://prometheus-prod-66-prod-us-east-3.grafana.net/api/prom}
grafana.prometheus.auth=${GRAFANA_PROMETHEUS_AUTH:}

# Micrometer tracing configuration
management.tracing.enabled=true
management.tracing.sampling.probability=${OTEL_SAMPLING_RATIO:0.1}
management.tracing.propagation.type=W3C

# Enable histogram metrics for percentile calculations
management.metrics.distribution.percentiles-histogram.http.server.requests=true
management.metrics.distribution.slo.http.server.requests=50ms,100ms,200ms,500ms,1s,5s

# Application info
info.app.name=Strategiz Core API
info.app.version=@project.version@
info.app.environment=production

# Frontend URL configuration
application.frontend-url=https://strategiz.io
frontend.url=https://strategiz.io

# OAuth Configuration for Authentication
# Auth portal is the centralized SSO provider for all Strategiz apps
oauth.frontend-url=https://auth.strategiz.io

# Passkey Configuration for Production
passkey.rpId=strategiz.io
passkey.rpName=Strategiz
passkey.challengeTimeoutMs=60000

# OAuth credentials loaded from Vault via OAuthVaultConfig
# Google OAuth Configuration (production)
oauth.providers.google.redirect-uri=https://api.strategiz.io/v1/auth/oauth/google/signin/callback
oauth.providers.google.signup-redirect-uri=https://api.strategiz.io/v1/auth/oauth/google/signup/callback
oauth.providers.google.auth-url=https://accounts.google.com/o/oauth2/auth
oauth.providers.google.token-url=https://oauth2.googleapis.com/token
oauth.providers.google.user-info-url=https://www.googleapis.com/oauth2/v3/userinfo
oauth.providers.google.scope=email profile openid

# Facebook OAuth Configuration (production)
oauth.providers.facebook.redirect-uri=https://api.strategiz.io/v1/auth/oauth/facebook/signin/callback
oauth.providers.facebook.signup-redirect-uri=https://api.strategiz.io/v1/auth/oauth/facebook/signup/callback
oauth.providers.facebook.auth-url=https://www.facebook.com/v12.0/dialog/oauth
oauth.providers.facebook.token-url=https://graph.facebook.com/v12.0/oauth/access_token
oauth.providers.facebook.user-info-url=https://graph.facebook.com/me
oauth.providers.facebook.scope=email,public_profile

# Coinbase OAuth Configuration (production) - for provider connections
oauth.providers.coinbase.redirect-uri=https://api.strategiz.io/v1/providers/callback/cb
oauth.providers.coinbase.auth-url=https://www.coinbase.com/oauth/authorize
oauth.providers.coinbase.scope=wallet:accounts:read,wallet:transactions:read,wallet:buys:read,wallet:sells:read

# Alpaca OAuth Configuration
oauth.providers.alpaca.redirect-uri=https://api.strategiz.io/v1/providers/callback/alpaca
oauth.providers.alpaca.auth-url=https://app.alpaca.markets/oauth/authorize
oauth.providers.alpaca.token-url=https://api.alpaca.markets/oauth/token
oauth.providers.alpaca.scope=account:read trading:write data:read

# Schwab OAuth Configuration
oauth.providers.schwab.redirect-uri=https://api.strategiz.io/v1/providers/callback/schwab

# E*TRADE OAuth 1.0a Configuration (uses consumer-key/consumer-secret)
oauth.providers.etrade.redirect-uri=https://api.strategiz.io/v1/providers/callback/etrade
oauth.providers.etrade.authorize-url=https://us.etrade.com/e/t/etws/authorize
oauth.providers.etrade.api-url=https://api.etrade.com

# Disable development features
spring.devtools.enabled=false

# Disable JPA/Hibernate auto-configuration (using Firestore + ClickHouse, not SQL)
spring.jpa.enabled=false
spring.jpa.show-sql=false
spring.jpa.hibernate.ddl-auto=none
spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration

# Bean definition overriding (required for RestTemplate bean conflicts)
spring.main.allow-bean-definition-overriding=true

# OpenTelemetry enabled for metrics export to Grafana Cloud
# Configured via otel.* properties above (lines 57-95)

# Cache Configuration (Ehcache for market data caching)
spring.cache.type=jcache
spring.cache.jcache.config=classpath:ehcache.xml

# Performance optimizations
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.default-property-inclusion=non_null

# Gemini AI Configuration (legacy - deprecated)
gemini.api.url=https://generativelanguage.googleapis.com
gemini.model=gemini-2.0-flash-exp
gemini.temperature=0.7
gemini.max-tokens=2048

# ====================================================
# Google Vertex AI Configuration
# ====================================================
# All LLM providers (Gemini, Claude, OpenAI, Llama, Mistral, Cohere) use Vertex AI
# Authentication via Application Default Credentials (ADC)
vertex.ai.project-id=43628135674
vertex.ai.location=us-east1

# Gemini Vertex AI
gemini.vertex.project-id=${vertex.ai.project-id}
gemini.vertex.location=${vertex.ai.location}
gemini.vertex.model=gemini-2.5-flash
gemini.vertex.temperature=0.7
gemini.vertex.max-tokens=8192
gemini.vertex.enabled=true

# Claude Vertex AI (DISABLED - using direct Anthropic API for Claude 4.5 models)
claude.vertex.project-id=${vertex.ai.project-id}
claude.vertex.location=${vertex.ai.location}
claude.vertex.model=claude-haiku-4-5
claude.vertex.temperature=0.7
claude.vertex.max-tokens=8192
claude.vertex.enabled=false

# OpenAI Vertex AI
openai.vertex.project-id=${vertex.ai.project-id}
openai.vertex.location=${vertex.ai.location}
openai.vertex.model=gpt-4o-mini
openai.vertex.temperature=0.7
openai.vertex.max-tokens=8192
openai.vertex.enabled=true

# Llama Vertex AI (Meta)
llama.vertex.project-id=${vertex.ai.project-id}
llama.vertex.location=${vertex.ai.location}
llama.vertex.model=llama-3.1-8b-instruct-maas
llama.vertex.temperature=0.7
llama.vertex.max-tokens=8192
llama.vertex.enabled=true

# Mistral Vertex AI
mistral.vertex.project-id=${vertex.ai.project-id}
mistral.vertex.location=${vertex.ai.location}
mistral.vertex.model=mistral-nemo
mistral.vertex.temperature=0.7
mistral.vertex.max-tokens=8192
mistral.vertex.enabled=true

# Cohere Vertex AI
cohere.vertex.project-id=${vertex.ai.project-id}
cohere.vertex.location=${vertex.ai.location}
cohere.vertex.model=command-r
cohere.vertex.temperature=0.7
cohere.vertex.max-tokens=8192
cohere.vertex.enabled=true

# Anthropic Direct API (Claude 4.5 models)
anthropic.direct.api-url=https://api.anthropic.com
anthropic.direct.model=claude-opus-4-5-20251101
anthropic.direct.temperature=0.7
anthropic.direct.max-tokens=8192
anthropic.direct.timeout-seconds=60
anthropic.direct.enabled=true

# xAI Direct API (Grok 4.1 models - Nov 2025)
grok.direct.api-url=https://api.x.ai
grok.direct.model=grok-4.1-fast
grok.direct.temperature=0.7
grok.direct.max-tokens=8192
grok.direct.timeout-seconds=60
grok.direct.enabled=true

# OpenAI Direct API (GPT-4o, o1 models)
openai.direct.api-url=https://api.openai.com
openai.direct.model=gpt-4o
openai.direct.temperature=0.7
openai.direct.max-tokens=8192
openai.direct.timeout-seconds=60
openai.direct.enabled=true

# ====================================================
# Market Data Batch Jobs (Production)
# ====================================================
# Backfill job - disabled (IEX feed has limited historical data)
# To get 7+ years, upgrade to Alpaca SIP feed (~$99/month)
marketdata.batch.backfill-enabled=false
marketdata.batch.backfill-years=7
marketdata.batch.backfill-timeframes=1D,1H,1W,1M
marketdata.batch.thread-pool-size=5
marketdata.batch.batch-size=1000
marketdata.batch.backfill-timeout-minutes=480

# Incremental job - runs every 5 minutes during market hours
marketdata.batch.incremental-enabled=true
marketdata.batch.incremental-cron=0 */5 * * * MON-FRI
marketdata.batch.incremental-lookback-hours=2

# Daily end-of-day sync job - runs at 5 PM ET (22:00 UTC) Mon-Fri
# 48-hour lookback handles weekends (Friday data collected on Monday)
marketdata.batch.daily-sync-enabled=true
marketdata.batch.daily-sync-cron=0 0 22 * * MON-FRI
marketdata.batch.daily-sync-lookback-hours=48

# ====================================================
# ClickHouse Cloud Configuration (market data storage)
# ====================================================
# Replaces TimescaleDB - 10-100x faster queries, 10-20x better compression
# Credentials loaded from Vault: secret/strategiz/clickhouse
# Required secrets: host, port, database, username, password
strategiz.clickhouse.enabled=true
strategiz.clickhouse.ssl=true
strategiz.clickhouse.pool.max-pool-size=10
strategiz.clickhouse.pool.min-idle=2
# Increased to 60s for ClickHouse Cloud initial connection (was 10s)
strategiz.clickhouse.pool.connection-timeout-ms=60000
strategiz.clickhouse.pool.idle-timeout-ms=300000

# ====================================================
# SendGrid Email Notification Configuration
# ====================================================
# Credentials loaded from Vault: secret/strategiz/sendgrid
# Required secrets: api-key, from-email, from-name
sendgrid.enabled=true
sendgrid.api.key=${SENDGRID_API_KEY:}
sendgrid.from.email=${SENDGRID_FROM_EMAIL:noreply@strategiz.io}
sendgrid.from.name=${SENDGRID_FROM_NAME:Strategiz Alerts}
app.frontend.url=https://strategiz.io

# ====================================================
# Twilio SMS Notification Configuration
# ====================================================
# Credentials loaded from Vault: secret/strategiz/twilio
# Required secrets: account-sid, auth-token, phone-number
twilio.enabled=true
twilio.account-sid=${TWILIO_ACCOUNT_SID:}
twilio.auth-token=${TWILIO_AUTH_TOKEN:}
twilio.phone-number=${TWILIO_PHONE_NUMBER:}
twilio.mock-enabled=false

# Stripe Payment Configuration
# Credentials loaded from Vault: secret/strategiz/stripe
# Required secrets: api-secret-key, api-publishable-key, webhook-secret, price-trader, price-strategist
app.base-url=https://strategiz.io
stripe.api.secret-key=${STRIPE_SECRET_KEY:}
stripe.api.publishable-key=${STRIPE_PUBLISHABLE_KEY:}
stripe.webhook.secret=${STRIPE_WEBHOOK_SECRET:}
stripe.price.trader=${STRIPE_PRICE_TRADER:}
stripe.price.strategist=${STRIPE_PRICE_STRATEGIST:}

# ====================================================
# Robinhood Provider Configuration
# ====================================================
# Note: This uses an unofficial API. No OAuth available for third parties.
# Credentials stored in Vault: secret/strategiz/robinhood
robinhood.enabled=true
robinhood.api.url=https://api.robinhood.com
robinhood.client-id=${ROBINHOOD_CLIENT_ID:c82SH0WZOsabOXGP2sxqcj34FxkvfnWRZBKlBjFS}

# ====================================================
# Plaid Configuration
# ====================================================
# Controlled by feature flag (plaid_enabled in Firestore)
# Credentials loaded from Vault: secret/strategiz/plaid
# Required secrets: client-id, secret
plaid.enabled=false
plaid.environment=production
plaid.redirect-uri=https://api.strategiz.io/v1/providers/plaid/oauth-callback

# ====================================================
# GCP Billing / Costs Dashboard (Production)
# ====================================================
# Enabled with BigQuery billing export for real cost data
gcp.billing.enabled=true
gcp.billing.demo-mode=false
gcp.billing.use-bigquery=true
# Table name loaded from Vault: secret/strategiz/gcp-billing (billing-table field)
# Required secrets: billing-table, credentials (raw JSON service account key)

# AI Billing / Costs Tracking (Production)
ai.billing.enabled=true
# Credentials loaded from Vault: secret/strategiz/anthropic, secret/strategiz/openai, secret/strategiz/xai

# ====================================================
# ClickHouse Cloud Billing API (Real-time costs)
# ====================================================
# Fetches actual costs from ClickHouse Cloud API
# Credentials loaded from Vault: secret/strategiz/clickhouse-billing
# Required secrets: organization-id, key-id, key-secret
clickhouse.billing.enabled=true
clickhouse.billing.api-url=https://api.clickhouse.cloud
clickhouse.billing.timeout-seconds=30
# ====================================================
# Python Strategy Execution Service (gRPC)
# ====================================================
# Production Cloud Run service
strategiz.execution.service.host=strategiz-execution-bflhiwsnmq-ue.a.run.app
strategiz.execution.service.port=443
strategiz.execution.service.use-tls=true

# GitHub API Configuration (for Automation & Agents)
# GitHub App authentication for triggering accessibility scans
# Credentials loaded from environment variables (injected by Cloud Run)
github.app.id=${GITHUB_APP_ID:}
github.app.installation-id=${GITHUB_APP_INSTALLATION_ID:}
github.app.private-key=${GITHUB_APP_PRIVATE_KEY:}
# Legacy token support (fallback if GitHub App not configured)
github.token=${GITHUB_TOKEN:}

# ====================================================
# Subscription Costs (Fixed Monthly Expenses)
# ====================================================
# Claude Pro/Max subscription for AI development assistance
subscriptions.claude.monthly-cost=200.00
subscriptions.claude.name=Claude Pro
subscriptions.claude.enabled=true

# ====================================================
# reCAPTCHA Enterprise Configuration (Fraud Detection)
# ====================================================
# Used by FraudDetectionService for signup/login protection
# Credentials loaded from Vault: secret/strategiz/recaptcha
# Required secrets: site-key
recaptcha.enabled=true
recaptcha.project-id=strategiz-io
recaptcha.site-key=${RECAPTCHA_SITE_KEY:6Le7rEosAAAAANqsIwjkhbSwq_4fGk85owRGbAVa}
recaptcha.threshold=0.5
recaptcha.mock-enabled=false
