<mxfile host="app.diagrams.net" modified="2024-12-19T12:00:00.000Z" agent="5.0" etag="abc123" version="24.7.17">
  <diagram name="TOTP Flow" id="totp-flow-diagram">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="title" value="TOTP Authentication Flow" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="450" y="20" width="270" height="30" as="geometry" />
        </mxCell>
        
        <!-- Registration Flow Section -->
        <mxCell id="reg-title" value="1. TOTP Registration Flow" style="text;html=1;strokeColor=none;fillColor=#e1d5e7;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=16;fontStyle=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="50" y="70" width="200" height="30" as="geometry" />
        </mxCell>
        
        <!-- User starts registration -->
        <mxCell id="user-start" value="User Clicks&#xa;&quot;Setup Authenticator&quot;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="50" y="120" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Frontend calls backend -->
        <mxCell id="frontend-init" value="Frontend&#xa;POST /setup/initialize" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="230" y="120" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Controller receives request -->
        <mxCell id="controller-init" value="TotpRegistrationController&#xa;.initializeSetup()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="410" y="120" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Service generates secret -->
        <mxCell id="service-generate" value="TotpRegistrationService&#xa;.generateTotpSecret()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="610" y="120" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Database check -->
        <mxCell id="db-check" value="UserRepository&#xa;Check if user exists" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="810" y="120" width="100" height="60" as="geometry" />
        </mxCell>
        
        <!-- Generate secret and QR -->
        <mxCell id="generate-qr" value="Generate Base32 Secret&#xa;Create QR Code URI&#xa;Store temporarily" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="610" y="220" width="140" height="80" as="geometry" />
        </mxCell>
        
        <!-- Return QR to frontend -->
        <mxCell id="return-qr" value="Return QR Code URI&#xa;to Frontend" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="230" y="220" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- User scans QR -->
        <mxCell id="user-scan" value="User Scans QR Code&#xa;with Authenticator App" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="50" y="220" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- User enters code -->
        <mxCell id="user-code" value="User Enters&#xa;First TOTP Code" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="50" y="320" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Frontend complete -->
        <mxCell id="frontend-complete" value="Frontend&#xa;POST /setup/complete" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="230" y="320" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Controller complete -->
        <mxCell id="controller-complete" value="TotpRegistrationController&#xa;.completeRegistration()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="410" y="320" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Service verify -->
        <mxCell id="service-verify" value="TotpRegistrationService&#xa;.enableTotp()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="610" y="320" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Verify code -->
        <mxCell id="verify-code" value="Verify TOTP Code&#xa;Create TotpAuthMethod&#xa;Save to Database" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="610" y="420" width="140" height="80" as="geometry" />
        </mxCell>
        
        <!-- Database save -->
        <mxCell id="db-save" value="UserRepository&#xa;Save AuthMethod&#xa;to User Document" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="810" y="420" width="100" height="80" as="geometry" />
        </mxCell>
        
        <!-- Success response -->
        <mxCell id="success-response" value="Success Response&#xa;TOTP Enabled" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="50" y="420" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Authentication Flow Section -->
        <mxCell id="auth-title" value="2. TOTP Authentication Flow" style="text;html=1;strokeColor=none;fillColor=#e1d5e7;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=16;fontStyle=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="50" y="540" width="200" height="30" as="geometry" />
        </mxCell>
        
        <!-- User signin -->
        <mxCell id="user-signin" value="User Enters Email&#xa;and TOTP Code" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="50" y="590" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Frontend auth -->
        <mxCell id="frontend-auth" value="Frontend&#xa;POST /authenticate" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="230" y="590" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Controller auth -->
        <mxCell id="controller-auth" value="TotpAuthController&#xa;.authenticate()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="410" y="590" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Service auth -->
        <mxCell id="service-auth" value="TotpAuthService&#xa;.authenticateWithTotp()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="610" y="590" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Database lookup -->
        <mxCell id="db-lookup" value="UserRepository&#xa;Find User &amp; TOTP&#xa;AuthMethod" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="810" y="590" width="100" height="60" as="geometry" />
        </mxCell>
        
        <!-- Verify auth code -->
        <mxCell id="verify-auth" value="Verify TOTP Code&#xa;Update lastVerifiedAt&#xa;Generate Session" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="610" y="690" width="140" height="80" as="geometry" />
        </mxCell>
        
        <!-- Database update -->
        <mxCell id="db-update" value="UserRepository&#xa;Update&#xa;lastVerifiedAt" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="810" y="690" width="100" height="80" as="geometry" />
        </mxCell>
        
        <!-- Auth success -->
        <mxCell id="auth-success" value="Authentication Success&#xa;User Logged In" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="50" y="690" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Error Handling -->
        <mxCell id="error-title" value="Error Handling" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="970" y="70" width="120" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="error-user-not-found" value="User Not Found" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="970" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="error-invalid-code" value="Invalid TOTP Code" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="970" y="180" width="120" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="error-expired-session" value="Expired Session Token" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="970" y="240" width="120" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="error-already-enabled" value="TOTP Already Enabled" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="970" y="300" width="120" height="40" as="geometry" />
        </mxCell>
        
        <!-- Arrows for Registration Flow -->
        <mxCell id="arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="user-start" target="frontend-init">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="frontend-init" target="controller-init">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="controller-init" target="service-generate">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=15;" edge="1" parent="1" source="service-generate" target="db-check">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="service-generate" target="generate-qr">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="generate-qr" target="return-qr">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="return-qr" target="user-scan">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="user-scan" target="user-code">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="user-code" target="frontend-complete">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="frontend-complete" target="controller-complete">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="controller-complete" target="service-verify">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow12" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="service-verify" target="verify-code">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow13" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=25;" edge="1" parent="1" source="verify-code" target="db-save">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="verify-code" target="success-response">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="680" y="500" />
              <mxPoint x="400" y="500" />
              <mxPoint x="400" y="450" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Arrows for Authentication Flow -->
        <mxCell id="arrow15" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="user-signin" target="frontend-auth">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow16" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="frontend-auth" target="controller-auth">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow17" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="controller-auth" target="service-auth">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow18" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=15;" edge="1" parent="1" source="service-auth" target="db-lookup">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow19" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="service-auth" target="verify-auth">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow20" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=25;" edge="1" parent="1" source="verify-auth" target="db-update">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow21" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="verify-auth" target="auth-success">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="680" y="770" />
              <mxPoint x="400" y="770" />
              <mxPoint x="400" y="720" />
            </Array>
          </mxGeometry>
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile> 