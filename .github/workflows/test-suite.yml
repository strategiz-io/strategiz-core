name: Test Suite Execution

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test level to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend
          - python

jobs:
  backend-tests:
    name: Backend Java Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_level == 'all' || github.event.inputs.test_level == 'backend' || github.event.inputs.test_level == ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Maven tests
        run: mvn test -DskipTests=false
        continue-on-error: true

      - name: Generate test results JSON
        if: always()
        run: |
          python3 scripts/aggregate-test-results.py \
            --type junit \
            --input-dir . \
            --output backend-results.json \
            --app-id backend-api \
            --commit-hash ${{ github.sha }} \
            --branch ${{ github.ref_name }} \
            --workflow-run-id ${{ github.run_id }} \
            --workflow-run-url ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload test results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend-results.json
          retention-days: 30

      - name: Post results to backend (main branch only)
        if: github.ref == 'refs/heads/main' && always()
        run: |
          curl -X POST "${{ secrets.API_URL }}/v1/console/tests/ci/results" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.TEST_RESULTS_TOKEN }}" \
            -d @backend-results.json \
            --fail-with-body || echo "Failed to post results to backend"

  frontend-e2e-tests:
    name: Frontend E2E Tests (Playwright)
    runs-on: ubuntu-latest
    if: github.event.inputs.test_level == 'all' || github.event.inputs.test_level == 'frontend' || github.event.inputs.test_level == ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: strategiz-ui/package-lock.json

      - name: Install dependencies
        working-directory: strategiz-ui
        run: npm ci

      - name: Install Playwright browsers
        working-directory: strategiz-ui
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        working-directory: strategiz-ui
        run: npm run test:e2e
        continue-on-error: true

      - name: Generate test results JSON
        if: always()
        working-directory: strategiz-ui
        run: |
          python3 ../scripts/aggregate-test-results.py \
            --type playwright \
            --input-dir playwright-results \
            --output frontend-e2e-results.json \
            --app-id frontend-web \
            --commit-hash ${{ github.sha }} \
            --branch ${{ github.ref_name }} \
            --workflow-run-id ${{ github.run_id }} \
            --workflow-run-url ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload test results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-e2e-test-results
          path: strategiz-ui/frontend-e2e-results.json
          retention-days: 30

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: strategiz-ui/playwright-report/
          retention-days: 30

      - name: Post results to backend (main branch only)
        if: github.ref == 'refs/heads/main' && always()
        working-directory: strategiz-ui
        run: |
          curl -X POST "${{ secrets.API_URL }}/v1/console/tests/ci/results" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.TEST_RESULTS_TOKEN }}" \
            -d @frontend-e2e-results.json \
            --fail-with-body || echo "Failed to post results to backend"

  python-tests:
    name: Python Microservice Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_level == 'all' || github.event.inputs.test_level == 'python' || github.event.inputs.test_level == ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: application-strategy-execution/requirements.txt

      - name: Install dependencies
        working-directory: application-strategy-execution
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-json-report pytest-cov

      - name: Run pytest
        working-directory: application-strategy-execution
        run: |
          pytest tests/ \
            --json-report \
            --json-report-file=../python-test-results.json \
            --cov=strategiz_execution \
            --cov-report=term \
            --cov-report=html
        continue-on-error: true

      - name: Generate aggregated results JSON
        if: always()
        run: |
          python3 scripts/aggregate-test-results.py \
            --type pytest \
            --input-file python-test-results.json \
            --output python-results.json \
            --app-id python-execution \
            --commit-hash ${{ github.sha }} \
            --branch ${{ github.ref_name }} \
            --workflow-run-id ${{ github.run_id }} \
            --workflow-run-url ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload test results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-test-results
          path: python-results.json
          retention-days: 30

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: application-strategy-execution/htmlcov/
          retention-days: 30

      - name: Post results to backend (main branch only)
        if: github.ref == 'refs/heads/main' && always()
        run: |
          curl -X POST "${{ secrets.API_URL }}/v1/console/tests/ci/results" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.TEST_RESULTS_TOKEN }}" \
            -d @python-results.json \
            --fail-with-body || echo "Failed to post results to backend"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-e2e-tests, python-tests]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Generate summary
        run: |
          echo "# Test Suite Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Backend
          if [ -f "test-results/backend-test-results/backend-results.json" ]; then
            echo "### âœ… Backend Tests" >> $GITHUB_STEP_SUMMARY
            echo "Results posted to test runner console" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Backend Tests - Not Run" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Frontend
          if [ -f "test-results/frontend-e2e-test-results/frontend-e2e-results.json" ]; then
            echo "### âœ… Frontend E2E Tests" >> $GITHUB_STEP_SUMMARY
            echo "Results posted to test runner console" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Frontend E2E Tests - Not Run" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Python
          if [ -f "test-results/python-test-results/python-results.json" ]; then
            echo "### âœ… Python Tests" >> $GITHUB_STEP_SUMMARY
            echo "Results posted to test runner console" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Python Tests - Not Run" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed results in the [Test Runner Console](https://console.strategiz.io/tests)" >> $GITHUB_STEP_SUMMARY
